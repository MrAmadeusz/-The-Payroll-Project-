<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Feature Request Dashboard</title>
    <style>
        body {
            font-family: 'Google Sans', Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #f8f9fa;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 16px;
            margin: -16px -16px 20px -16px;
            border-radius: 0 0 8px 8px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filters {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        button {
            background: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #1557b0;
        }
        
        button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #3c4043;
            border: 1px solid #dadce0;
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }
        
        .btn-danger {
            background: #ea4335;
        }
        
        .btn-danger:hover {
            background: #d33b2c;
        }
        
        .btn-success {
            background: #34a853;
        }
        
        .btn-success:hover {
            background: #2e7d2e;
        }
        
        .request-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dadce0;
            border-radius: 4px;
        }
        
        .request-item {
            padding: 12px;
            border-bottom: 1px solid #e8eaed;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .request-item:hover {
            background-color: #f1f3f4;
        }
        
        .request-item:last-child {
            border-bottom: none;
        }
        
        .request-item.selected {
            background-color: #e8f0fe;
            border-left: 3px solid #1a73e8;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        
        .request-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #5f6368;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .request-title {
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }
        
        .request-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: #5f6368;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-submitted { background: #fef7e0; color: #f9ab00; }
        .status-under-review { background: #e8f0fe; color: #1a73e8; }
        .status-approved { background: #e6f4ea; color: #34a853; }
        .status-rejected { background: #fce8e6; color: #ea4335; }
        .status-in-development { background: #f3e8fd; color: #9c27b0; }
        .status-completed { background: #e8f5e8; color: #2e7d32; }
        
        .priority-high { color: #ea4335; font-weight: 600; }
        .priority-medium { color: #f9ab00; }
        .priority-low { color: #34a853; }
        
        .request-details {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .request-details.visible {
            display: block;
        }
        
        .detail-row {
            margin-bottom: 12px;
        }
        
        .detail-label {
            font-weight: 500;
            color: #3c4043;
            margin-bottom: 4px;
        }
        
        .detail-value {
            color: #5f6368;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dadce0;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .quick-actions button {
            flex: 1;
            min-width: 120px;
            padding: 6px 8px;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #5f6368;
        }
        
        .error {
            background: #fce8e6;
            color: #d93025;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .success {
            background: #e6f4ea;
            color: #137333;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #5f6368;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .update-form {
            display: none;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .update-form.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí° Feature Request Management</h1>
    </div>

    <div id="loadingIndicator" class="loading">
        Loading feature requests...
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div id="mainContent" style="display: none;">
        <!-- Statistics Overview -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>

        <!-- Quick Actions -->
        <div class="section">
            <div class="section-title">‚ö° Quick Actions</div>
            <div class="quick-actions">
                <button onclick="showSubmissionForm()">‚ûï New Request</button>
                <button onclick="refreshDashboard()">üîÑ Refresh</button>
                <button onclick="exportRequests()">üìä Export</button>
                <button onclick="showAnalytics()">üìà Analytics</button>
            </div>
        </div>

        <!-- Filters -->
        <div class="section">
            <div class="section-title">üîç Filters</div>
            <div class="filters">
                <div class="filter-row">
                    <select id="filterStatus">
                        <option value="">All Status</option>
                    </select>
                    <select id="filterPriority">
                        <option value="">All Priority</option>
                    </select>
                </div>
                <div class="filter-row">
                    <select id="filterCategory">
                        <option value="">All Categories</option>
                    </select>
                    <select id="filterSubmitter">
                        <option value="">All Submitters</option>
                    </select>
                </div>
                <button onclick="applyFilters()" style="grid-column: span 2;">Apply Filters</button>
            </div>
        </div>

        <!-- Request List -->
        <div class="section">
            <div class="section-title">üìã Feature Requests</div>
            <div id="requestList" class="request-list">
                <!-- Requests will be populated here -->
            </div>
        </div>

        <!-- Request Details -->
        <div id="requestDetails" class="request-details">
            <!-- Details will be populated here -->
        </div>

        <!-- Update Form -->
        <div id="updateForm" class="update-form">
            <div class="section-title">‚úèÔ∏è Update Request</div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <select id="updateStatus"></select>
            </div>
            <div class="detail-row">
                <div class="detail-label">Priority:</div>
                <select id="updatePriority"></select>
            </div>
            <div class="detail-row">
                <div class="detail-label">Estimated Effort:</div>
                <select id="updateEffort"></select>
            </div>
            <div class="detail-row">
                <div class="detail-label">Your Notes:</div>
                <textarea id="updateNotes" placeholder="Add your notes here..."></textarea>
            </div>
            <div class="actions">
                <button onclick="saveUpdates()" class="btn-success">üíæ Save</button>
                <button onclick="cancelUpdate()" class="btn-secondary">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let allRequests = [];
        let filteredRequests = [];
        let selectedRequest = null;
        let filterOptions = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });

        async function loadDashboard() {
            try {
                showLoading(true);
                hideMessages();

                // Load filter options using the clean backend
                const filterResult = await callServerFunction('getFeatureRequestFilterOptionsForUI');
                if (!filterResult || !filterResult.success) {
                    throw new Error('Failed to load filter options: ' + (filterResult?.error || 'Unknown error'));
                }

                filterOptions = {
                    statusOptions: filterResult.statusOptions || [],
                    priorityOptions: filterResult.priorityOptions || [],
                    categoryOptions: filterResult.categoryOptions || [],
                    submitter: filterResult.submitter || [],
                    status: filterResult.status || [],
                    priority: filterResult.priority || [],
                    category: filterResult.category || [],
                    effortOptions: filterResult.effortOptions || []
                };

                populateFilterDropdowns();

                // Load requests using raw data approach
                const rawData = await callServerFunction('getRawFeatureRequestData');
                if (!rawData) {
                    throw new Error('Failed to load requests: No data returned');
                }

                // Process dates client-side
                allRequests = rawData.map(request => ({
                    ...request,
                    submissionDate: request.submissionDate ? new Date(request.submissionDate) : new Date(),
                    lastUpdated: request.lastUpdated ? new Date(request.lastUpdated) : null,
                    completedDate: request.completedDate ? new Date(request.completedDate) : null
                }));

                filteredRequests = [...allRequests];

                // Update UI
                updateStatistics();
                renderRequestList();
                
                showLoading(false);
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error("Dashboard loading error:", error);
                showError('Failed to load dashboard: ' + error.message);
                showLoading(false);
            }
        }

        function populateFilterDropdowns() {
            const statusSelect = document.getElementById('filterStatus');
            const prioritySelect = document.getElementById('filterPriority');
            const categorySelect = document.getElementById('filterCategory');
            const submitterSelect = document.getElementById('filterSubmitter');

            // Populate status options
            filterOptions.statusOptions?.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });

            // Populate priority options
            filterOptions.priorityOptions?.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority;
                option.textContent = priority;
                prioritySelect.appendChild(option);
            });

            // Populate category options
            filterOptions.categoryOptions?.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // Populate submitter options
            (filterOptions.submitter || []).forEach(submitter => {
                const option = document.createElement('option');
                option.value = submitter;
                option.textContent = submitter;
                submitterSelect.appendChild(option);
            });

            // Populate update form dropdowns
            populateUpdateDropdowns();
        }

        function populateUpdateDropdowns() {
            const updateStatus = document.getElementById('updateStatus');
            const updatePriority = document.getElementById('updatePriority');
            const updateEffort = document.getElementById('updateEffort');

            // Clear existing options
            updateStatus.innerHTML = '';
            updatePriority.innerHTML = '';
            updateEffort.innerHTML = '';

            // Status options
            filterOptions.statusOptions?.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                updateStatus.appendChild(option);
            });

            // Priority options
            filterOptions.priorityOptions?.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority;
                option.textContent = priority;
                updatePriority.appendChild(option);
            });

            // Effort options
            filterOptions.effortOptions?.forEach(effort => {
                const option = document.createElement('option');
                option.value = effort;
                option.textContent = effort;
                updateEffort.appendChild(option);
            });
        }

        function updateStatistics() {
            const stats = {
                total: allRequests.length,
                active: allRequests.filter(r => !['Completed', 'Rejected'].includes(r.status)).length,
                needingAttention: allRequests.filter(r => ['Submitted', 'Under Review'].includes(r.status)).length,
                completed: allRequests.filter(r => r.status === 'Completed').length
            };

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.active}</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.needingAttention}</div>
                    <div class="stat-label">Need Attention</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.completed}</div>
                    <div class="stat-label">Completed</div>
                </div>
            `;
        }

        function renderRequestList() {
            const requestList = document.getElementById('requestList');
            
            if (filteredRequests.length === 0) {
                requestList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí°</div>
                        <div>No feature requests found</div>
                        <div style="margin-top: 8px; font-size: 12px;">Try adjusting your filters or create a new request</div>
                    </div>
                `;
                return;
            }

            const requestsHtml = filteredRequests.map(request => `
                <div class="request-item" onclick="selectRequest('${request.requestId}')">
                    <div class="request-header">
                        <div class="request-id">${request.requestId}</div>
                        <div class="status-badge status-${request.status.toLowerCase().replace(/\s+/g, '-')}">${request.status}</div>
                    </div>
                    <div class="request-title">${request.title}</div>
                    <div class="request-meta">
                        <span class="priority-${request.priority.toLowerCase()}">${request.priority}</span>
                        <span>‚Ä¢</span>
                        <span>${request.category}</span>
                        <span>‚Ä¢</span>
                        <span>${request.submitter}</span>
                        <span>‚Ä¢</span>
                        <span>${formatDate(request.submissionDate)}</span>
                    </div>
                </div>
            `).join('');

            requestList.innerHTML = requestsHtml;
        }

        function selectRequest(requestId) {
            selectedRequest = allRequests.find(r => r.requestId === requestId);
            
            // Update selection visual
            document.querySelectorAll('.request-item').forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Show request details
            showRequestDetails(selectedRequest);
        }

        function showRequestDetails(request) {
            const detailsDiv = document.getElementById('requestDetails');
            
            detailsDiv.innerHTML = `
                <div class="section-title">üìÑ Request Details</div>
                <div class="detail-row">
                    <div class="detail-label">Title:</div>
                    <div class="detail-value">${request.title}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Description:</div>
                    <div class="detail-value">${request.description}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Business Justification:</div>
                    <div class="detail-value">${request.businessJustification || 'Not provided'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Dependencies:</div>
                    <div class="detail-value">${request.dependencies || 'None specified'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Your Notes:</div>
                    <div class="detail-value">${request.yourNotes || 'No notes yet'}</div>
                </div>
                <div class="actions">
                    <button onclick="showUpdateForm()" class="btn-secondary">‚úèÔ∏è Edit</button>
                    <button onclick="advanceStatus()" class="btn-success">‚è≠Ô∏è Advance</button>
                </div>
            `;
            
            detailsDiv.classList.add('visible');
        }

        function showUpdateForm() {
            if (!selectedRequest) return;
            
            document.getElementById('updateStatus').value = selectedRequest.status;
            document.getElementById('updatePriority').value = selectedRequest.priority;
            document.getElementById('updateEffort').value = selectedRequest.estimatedEffort;
            document.getElementById('updateNotes').value = selectedRequest.yourNotes || '';
            
            document.getElementById('updateForm').classList.add('visible');
        }

        function cancelUpdate() {
            document.getElementById('updateForm').classList.remove('visible');
        }

        async function saveUpdates() {
            if (!selectedRequest) return;
            
            try {
                const updates = {
                    status: document.getElementById('updateStatus').value,
                    priority: document.getElementById('updatePriority').value,
                    estimatedEffort: document.getElementById('updateEffort').value,
                    yourNotes: document.getElementById('updateNotes').value
                };

                showLoading(true);
                const result = await callServerFunction('updateFeatureRequestForUI', selectedRequest.requestId, updates);
                
                if (result.success) {
                    showSuccess('Request updated successfully');
                    cancelUpdate();
                    refreshDashboard();
                } else {
                    showError('Failed to update request: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                showError('Update failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function advanceStatus() {
            if (!selectedRequest) return;
            
            try {
                showLoading(true);
                const result = await callServerFunction('advanceFeatureRequestStatusForUI', selectedRequest.requestId, '');
                
                if (result.success) {
                    showSuccess('Request status advanced successfully');
                    refreshDashboard();
                } else {
                    showError('Failed to advance status: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                showError('Status advance failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const submitterFilter = document.getElementById('filterSubmitter').value;

            filteredRequests = allRequests.filter(request => {
                return (!statusFilter || request.status === statusFilter) &&
                       (!priorityFilter || request.priority === priorityFilter) &&
                       (!categoryFilter || request.category === categoryFilter) &&
                       (!submitterFilter || request.submitter === submitterFilter);
            });

            renderRequestList();
            
            // Hide details if selected request is no longer visible
            if (selectedRequest && !filteredRequests.some(r => r.requestId === selectedRequest.requestId)) {
                document.getElementById('requestDetails').classList.remove('visible');
                document.getElementById('updateForm').classList.remove('visible');
                selectedRequest = null;
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        function showSubmissionForm() {
            google.script.run.showFeatureRequestSubmissionForm();
        }

        async function exportRequests() {
            try {
                showLoading(true);
                const result = await callServerFunction('exportFeatureRequestsForUI', {}, {format: 'csv'});
                
                if (result.success) {
                    showSuccess('Export completed successfully');
                } else {
                    showError('Export failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                showError('Export failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showAnalytics() {
            google.script.run.showFeatureRequestAnalytics();
        }

        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function callServerFunction(functionName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [functionName](...args);
            });
        }
    </script>
</body>
</html>
