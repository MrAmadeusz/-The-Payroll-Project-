<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Enhanced New Maternity Case</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
        }
        
        .form-header h1 {
            color: #495057;
            margin: 0;
            font-size: 24px;
        }
        
        .form-header .subtitle {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group .required {
            color: #dc3545;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .form-control.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220,53,69,0.25);
        }
        
        .form-control.success {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40,167,69,0.25);
        }
        
        select.form-control {
            height: 40px;
        }
        
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .help-text.error {
            color: #dc3545;
        }
        
        .help-text.success {
            color: #28a745;
        }
        
        .help-text.warning {
            color: #ffc107;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #007bff;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .monthly-smp-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .monthly-smp-label {
            flex: 1;
            font-weight: 600;
            color: #495057;
            min-width: 150px;
        }
        
        .monthly-smp-input {
            flex: 0 0 120px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
        }
        
        .monthly-smp-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        #total-smp-display {
            font-weight: bold;
            color: #007bff;
        }

        .cmp-section {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .cmp-header {
            font-weight: 700;
            font-size: 16px;
            color: #0056b3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payroll-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .payroll-info.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .payroll-info.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .validation-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h1>ü§± Enhanced Maternity Case</h1>
            <div class="subtitle">Create new case with enhanced CMP calculation and payroll validation</div>
        </div>

        <div id="error-message" class="error"></div>
        <div id="warning-message" class="warning"></div>
        <div id="success-message" class="success"></div>
        <div id="loading" class="loading">
            <p>‚è≥ Creating enhanced maternity case...</p>
            <p style="font-size: 12px;">Processing payroll periods and calculating CMP amounts</p>
        </div>

        <form id="maternity-form">
            <!-- Employee Selection -->
            <div class="form-group">
                <label for="employeeNumber">Employee Number <span class="required">*</span></label>
                <input type="text" id="employeeNumber" name="employeeNumber" class="form-control" required placeholder="Enter employee number...">
                <div id="employeeDetails" class="help-text" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <strong>Employee:</strong> <span id="employeeName"></span><br>
                    <strong>Location:</strong> <span id="employeeLocation"></span><br>
                    <strong>Pay Type:</strong> <span id="employeePayType"></span><br>
                    <strong>Staff Type:</strong> <span id="employeeStaffType"></span>
                </div>
                <div id="employeeError" class="help-text error" style="display: none;">
                    Employee not found
                </div>
            </div>

            <!-- Maternity Dates -->
            <div class="form-row">
                <div class="form-group">
                    <label for="babyDueDate">Baby Due Date <span class="required">*</span></label>
                    <input type="date" id="babyDueDate" name="babyDueDate" class="form-control" required>
                    <div class="help-text">Expected delivery date</div>
                </div>
                <div class="form-group">
                    <label for="maternityStartDate">Maternity Leave Start <span class="required">*</span></label>
                    <input type="date" id="maternityStartDate" name="maternityStartDate" class="form-control" required>
                    <div class="help-text">First day of maternity leave</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="smpStartDate">SMP Start Date <span class="required">*</span></label>
                    <input type="date" id="smpStartDate" name="smpStartDate" class="form-control" required>
                    <div class="help-text">When SMP payments begin</div>
                    <div id="smpValidation" class="payroll-info" style="display: none;">
                        <div id="smpValidationMessage"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="expectedReturnDate">Expected Return Date <span class="required">*</span></label>
                    <input type="date" id="expectedReturnDate" name="expectedReturnDate" class="form-control" required>
                    <div class="help-text">Planned return to work date</div>
                </div>
            </div>

            <!-- Enhanced CMP SECTION -->
            <div class="cmp-section">
                <div class="cmp-header">
                    üíº Enhanced Company Maternity Pay (CMP) Setup
                </div>
                <div class="help-text" style="margin-bottom: 15px;">
                    The system will automatically calculate CMP amounts using day-based tracking and payroll cutoff logic.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="averageWeeklyEarnings">Average Weekly Earnings <span class="required">*</span></label>
                        <input type="number" id="averageWeeklyEarnings" name="averageWeeklyEarnings" class="form-control" 
                               step="0.01" min="0" required placeholder="0.00">
                        <div class="help-text">Average weekly earnings from relevant period (¬£)</div>
                        <div id="cmpPreview" class="payroll-info" style="display: none;">
                            <div id="cmpPreviewMessage"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cmpWeeks">CMP Top-Up Weeks</label>
                        <input type="number" id="cmpWeeks" name="cmpWeeks" class="form-control" 
                               min="0" max="52" value="8" placeholder="8">
                        <div class="help-text">Number of weeks for company top-up (default: 8 weeks = 56 days)</div>
                    </div>
                </div>
            </div>

            <!-- Payment Details -->
            <div class="form-group">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; border-left: 4px solid #2196f3;">
                    <strong>üí∞ Monthly SMP Amounts</strong><br>
                    <span style="color: #1565c0;">Enter the SMP amount for each month of maternity leave. The system will automatically map these to the correct payroll periods.</span>
                </div>
            </div>
            
            <div id="monthly-smp-container" style="display: none;">
                <div class="form-group">
                    <label>Monthly SMP Breakdown <span class="required">*</span></label>
                    <div id="monthly-smp-inputs" style="max-height: 300px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 4px; padding: 15px; background: #f8f9fa;">
                        <!-- Monthly input fields will be generated here -->
                    </div>
                    <div class="help-text">
                        <strong>Total SMP: ¬£<span id="total-smp-display">0.00</span></strong><br>
                        <small>This total will be mapped to payroll periods and used for CMP calculations.</small>
                    </div>
                </div>
            </div>

            <!-- Holiday Balance -->
            <div class="form-group">
                <label for="preMaternityHolidays">Pre-Maternity Holiday Balance (days)</label>
                <input type="number" id="preMaternityHolidays" name="preMaternityHolidays" class="form-control" step="0.5" min="0" value="0">
                <div class="help-text">Unused holiday days before maternity leave starts</div>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-control" placeholder="Additional information, special circumstances, etc."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Create Enhanced Maternity Case</button>
            </div>
        </form>
    </div>

    <script>
        let currentEmployee = null; // Store the looked-up employee data
        let monthlyAmounts = {}; // Store monthly SMP amounts
        let smpValidationTimeout = null;
        
        // Enhanced employee number lookup with payroll validation
        document.getElementById('employeeNumber').addEventListener('blur', function() {
            const employeeNumber = this.value.trim();
            if (!employeeNumber) {
                hideEmployeeDetails();
                return;
            }
            
            // Show loading state
            this.classList.add('loading');
            
            // Look up employee with enhanced data
            google.script.run
                .withSuccessHandler(handleEmployeeLookup)
                .withFailureHandler(handleEmployeeLookupError)
                .lookupEmployeeByNumber(employeeNumber);
        });
        
        function handleEmployeeLookup(employee) {
            document.getElementById('employeeNumber').classList.remove('loading');
            
            if (employee) {
                currentEmployee = employee;
                document.getElementById('employeeName').textContent = employee.name;
                document.getElementById('employeeLocation').textContent = employee.location;
                document.getElementById('employeePayType').textContent = employee.payType;
                document.getElementById('employeeStaffType').textContent = employee.payType === 'Salary' ? 'Salaried' : 'Hourly';
                document.getElementById('employeeDetails').style.display = 'block';
                document.getElementById('employeeError').style.display = 'none';
                
                // Update CMP preview if we have earnings data
                updateCMPPreview();
                
                // Validate SMP start date if already entered
                const smpStartDate = document.getElementById('smpStartDate').value;
                if (smpStartDate) {
                    validateSMPStartDate();
                }
            } else {
                handleEmployeeLookupError();
            }
        }
        
        function handleEmployeeLookupError() {
            document.getElementById('employeeNumber').classList.remove('loading');
            hideEmployeeDetails();
            document.getElementById('employeeError').style.display = 'block';
            currentEmployee = null;
        }
        
        function hideEmployeeDetails() {
            document.getElementById('employeeDetails').style.display = 'none';
            document.getElementById('employeeError').style.display = 'none';
            document.getElementById('cmpPreview').style.display = 'none';
        }

        // Enhanced SMP start date validation with payroll checking
        document.getElementById('smpStartDate').addEventListener('change', function() {
            if (currentEmployee && this.value) {
                validateSMPStartDate();
            }
        });
        
        function validateSMPStartDate() {
            const smpStartDate = document.getElementById('smpStartDate').value;
            const smpField = document.getElementById('smpStartDate');
            const validationDiv = document.getElementById('smpValidation');
            const messageDiv = document.getElementById('smpValidationMessage');
            
            if (!currentEmployee || !smpStartDate) {
                validationDiv.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (smpValidationTimeout) {
                clearTimeout(smpValidationTimeout);
            }
            
            // Show loading
            messageDiv.innerHTML = '<div class="spinner"></div> Validating payroll period assignment...';
            validationDiv.className = 'payroll-info';
            validationDiv.style.display = 'block';
            
            // Debounced validation
            smpValidationTimeout = setTimeout(() => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success && result.validation.isValid) {
                            smpField.classList.remove('error');
                            smpField.classList.add('success');
                            validationDiv.className = 'payroll-info';
                            messageDiv.innerHTML = `‚úÖ ${result.validation.message}`;
                            
                            if (result.validation.payrollDetails) {
                                const details = result.validation.payrollDetails;
                                if (details.daysSinceCutoff) {
                                    messageDiv.innerHTML += `<br><small>Pay date: ${new Date(details.payDate).toLocaleDateString()} (${details.daysSinceCutoff} days after cutoff)</small>`;
                                } else {
                                    messageDiv.innerHTML += `<br><small>Pay date: ${new Date(details.payDate).toLocaleDateString()}</small>`;
                                }
                            }
                        } else {
                            smpField.classList.remove('success');
                            smpField.classList.add('error');
                            validationDiv.className = 'payroll-info error';
                            messageDiv.innerHTML = `‚ùå ${result.validation ? result.validation.error : 'Validation failed'}`;
                            
                            if (result.validation && result.validation.suggestion) {
                                messageDiv.innerHTML += `<br><small>${result.validation.suggestion}</small>`;
                            }
                        }
                    })
                    .withFailureHandler(function(error) {
                        smpField.classList.add('error');
                        validationDiv.className = 'payroll-info error';
                        messageDiv.innerHTML = `‚ùå Validation error: ${error.message}`;
                    })
                    .validateSMPStartDateForForm(currentEmployee.id, smpStartDate);
            }, 500);
        }

        // Auto-populate expected return date when maternity start is set
        document.getElementById('maternityStartDate').addEventListener('change', function() {
            const startDate = new Date(this.value);
            if (startDate) {
                // Add 52 weeks (364 days) for expected return
                const returnDate = new Date(startDate);
                returnDate.setDate(returnDate.getDate() + 364);
                document.getElementById('expectedReturnDate').value = returnDate.toISOString().split('T')[0];
                
                // Generate monthly SMP inputs
                generateMonthlySMPInputs();
            }
        });

        // Auto-populate SMP start date when maternity start is set (typically same day)
        document.getElementById('maternityStartDate').addEventListener('change', function() {
            const startDate = this.value;
            if (startDate && !document.getElementById('smpStartDate').value) {
                document.getElementById('smpStartDate').value = startDate;
                // Trigger validation
                if (currentEmployee) {
                    validateSMPStartDate();
                }
            }
        });
        
        // Update monthly inputs when expected return date changes
        document.getElementById('expectedReturnDate').addEventListener('change', function() {
            generateMonthlySMPInputs();
        });
        
        // Enhanced CMP preview
        document.getElementById('averageWeeklyEarnings').addEventListener('input', function() {
            updateCMPPreview();
        });
        
        document.getElementById('cmpWeeks').addEventListener('input', function() {
            updateCMPPreview();
        });
        
        function updateCMPPreview() {
            const averageWeekly = parseFloat(document.getElementById('averageWeeklyEarnings').value) || 0;
            const cmpWeeks = parseInt(document.getElementById('cmpWeeks').value) || 8;
            const previewDiv = document.getElementById('cmpPreview');
            const messageDiv = document.getElementById('cmpPreviewMessage');
            
            if (!currentEmployee || averageWeekly <= 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            // Calculate estimated CMP
            const cmpDays = cmpWeeks * 7;
            const dailyRate = averageWeekly / 7;
            const maxCMP = dailyRate * cmpDays;
            
            messageDiv.innerHTML = `üí° <strong>CMP Calculation Preview:</strong><br>
                Target: ¬£${averageWeekly}/week (¬£${dailyRate.toFixed(2)}/day)<br>
                Max CMP: ¬£${maxCMP.toFixed(2)} over ${cmpWeeks} weeks (${cmpDays} days)<br>
                <small>Actual amounts will be calculated based on SMP and payroll periods</small>`;
            
            previewDiv.className = 'payroll-info';
            previewDiv.style.display = 'block';
        }
        
        // ENHANCED: Generate monthly SMP input fields (February bug fixed)
        function generateMonthlySMPInputs() {
            const startDate = document.getElementById('maternityStartDate').value;
            const endDate = document.getElementById('expectedReturnDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('monthly-smp-container').style.display = 'none';
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start >= end) {
                document.getElementById('monthly-smp-container').style.display = 'none';
                return;
            }
            
            // FIXED: Calculate months between start and end (February bug fix)
            const months = [];
            let current = new Date(start.getFullYear(), start.getMonth(), 1); // Start at beginning of start month
            
            while (current < end) {
                const monthKey = current.getFullYear() + '-' + String(current.getMonth() + 1).padStart(2, '0');
                const monthLabel = current.toLocaleDateString('en-GB', { year: 'numeric', month: 'long' });
                
                months.push({
                    key: monthKey,
                    label: monthLabel,
                    month: current.getMonth() + 1,
                    year: current.getFullYear()
                });
                
                // Move to next month properly
                current.setMonth(current.getMonth() + 1);
                current.setDate(1); // Ensure we stay at the 1st of each month
            }
            
            // Generate HTML for monthly inputs
            const container = document.getElementById('monthly-smp-inputs');
            container.innerHTML = '';
            
            if (months.length === 0) {
                document.getElementById('monthly-smp-container').style.display = 'none';
                return;
            }
            
            months.forEach((month, index) => {
                const row = document.createElement('div');
                row.className = 'monthly-smp-row';
                
                const savedValue = monthlyAmounts[month.key] || '';
                
                row.innerHTML = `
                    <div class="monthly-smp-label">${month.label}</div>
                    <div style="flex: 0 0 30px; text-align: center; color: #6c757d;">¬£</div>
                    <input type="number" 
                           class="monthly-smp-input" 
                           data-month="${month.key}"
                           placeholder="0.00" 
                           step="0.01" 
                           min="0"
                           value="${savedValue}"
                           required>
                `;
                
                container.appendChild(row);
            });
            
            // Add event listeners to calculate total
            container.querySelectorAll('.monthly-smp-input').forEach(input => {
                input.addEventListener('input', calculateTotalSMP);
            });
            
            document.getElementById('monthly-smp-container').style.display = 'block';
            calculateTotalSMP();
        }
        
        // Calculate total SMP from monthly amounts
        function calculateTotalSMP() {
            const inputs = document.querySelectorAll('.monthly-smp-input');
            let total = 0;
            
            monthlyAmounts = {}; // Reset
            
            inputs.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                const monthKey = input.getAttribute('data-month');
                if (monthKey) {
                    monthlyAmounts[monthKey] = amount;
                    total += amount;
                }
            });
            
            document.getElementById('total-smp-display').textContent = total.toFixed(2);
        }
        
        // Get total SMP amount
        function getTotalSMP() {
            const total = Object.values(monthlyAmounts).reduce((sum, amount) => sum + (parseFloat(amount) || 0), 0);
            return total;
        }

        // Enhanced form submission with comprehensive validation
        document.getElementById('maternity-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Clear previous messages
            hideAllMessages();
            
            // Validate employee lookup first
            if (!currentEmployee) {
                showError('Please enter a valid employee number and wait for verification.');
                return;
            }
            
            if (!currentEmployee.id) {
                showError('Employee lookup successful but no ID found.');
                return;
            }
            
            // Collect form data
            const formElements = {
                employeeNumber: document.getElementById('employeeNumber'),
                babyDueDate: document.getElementById('babyDueDate'),
                maternityStartDate: document.getElementById('maternityStartDate'),
                smpStartDate: document.getElementById('smpStartDate'),
                expectedReturnDate: document.getElementById('expectedReturnDate'),
                averageWeeklyEarnings: document.getElementById('averageWeeklyEarnings'),
                cmpWeeks: document.getElementById('cmpWeeks'),
                preMaternityHolidays: document.getElementById('preMaternityHolidays'),
                notes: document.getElementById('notes')
            };
            
            const totalSMP = getTotalSMP();
            
            // Ensure we have the latest monthly amounts before submitting
            calculateTotalSMP();
            
            const formData = {
                employeeId: currentEmployee.id, // Use the looked-up employee ID
                employeeNumber: formElements.employeeNumber ? formElements.employeeNumber.value : '',
                babyDueDate: formElements.babyDueDate ? formElements.babyDueDate.value : '',
                maternityStartDate: formElements.maternityStartDate ? formElements.maternityStartDate.value : '',
                smpStartDate: formElements.smpStartDate ? formElements.smpStartDate.value : '',
                expectedReturnDate: formElements.expectedReturnDate ? formElements.expectedReturnDate.value : '',
                totalSMP: totalSMP, // Calculated from monthly amounts
                monthlySMP: JSON.parse(JSON.stringify(monthlyAmounts)), // Deep copy
                
                // Enhanced CMP FIELDS
                averageWeeklyEarnings: parseFloat(formElements.averageWeeklyEarnings.value) || 0,
                cmpWeeks: parseInt(formElements.cmpWeeks.value) || 8,
                
                preMaternityHolidays: formElements.preMaternityHolidays ? parseFloat(formElements.preMaternityHolidays.value) || 0 : 0,
                notes: formElements.notes ? formElements.notes.value : ''
            };
            
            // Enhanced validation
            const validationErrors = validateFormData(formData);
            if (validationErrors.length > 0) {
                showError('Validation errors: ' + validationErrors.join('; '));
                return;
            }
            
            // Show loading state only after all validation passes
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            
            // Submit to server with enhanced processing
            google.script.run
                .withSuccessHandler(handleEnhancedSuccess)
                .withFailureHandler(handleEnhancedError)
                .submitNewMaternityCase(formData);
        });
        
        function validateFormData(formData) {
            const errors = [];
            
            if (!formData.employeeId) errors.push('Employee selection');
            if (!formData.babyDueDate) errors.push('Baby due date');
            if (!formData.maternityStartDate) errors.push('Maternity start date');
            if (!formData.smpStartDate) errors.push('SMP start date');
            if (!formData.expectedReturnDate) errors.push('Expected return date');
            if (!formData.totalSMP || formData.totalSMP <= 0) errors.push('Monthly SMP amounts (total must be greater than ¬£0.00)');
            if (!formData.averageWeeklyEarnings || formData.averageWeeklyEarnings <= 0) errors.push('Average weekly earnings');
            
            // Date validation
            if (formData.maternityStartDate && formData.expectedReturnDate) {
                const start = new Date(formData.maternityStartDate);
                const end = new Date(formData.expectedReturnDate);
                if (start >= end) {
                    errors.push('Expected return date must be after maternity start date');
                }
            }
            
            // Validate that at least one monthly amount is entered
            const monthlyInputs = document.querySelectorAll('.monthly-smp-input');
            let hasMonthlyAmounts = false;
            monthlyInputs.forEach(input => {
                if (parseFloat(input.value) > 0) hasMonthlyAmounts = true;
            });
            
            if (monthlyInputs.length > 0 && !hasMonthlyAmounts) {
                errors.push('At least one monthly SMP amount must be greater than ¬£0.00');
            }
            
            return errors;
        }
        
        function handleEnhancedSuccess(result) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            
            if (result.success) {
                let message = result.message;
                if (result.payrollInfo) {
                    message += `<br><small>Payroll details: ${JSON.stringify(result.payrollInfo)}</small>`;
                }
                showSuccess(message);
                
                // Reset form
                document.getElementById('maternity-form').reset();
                hideEmployeeDetails();
                currentEmployee = null;
                monthlyAmounts = {};
                
                // Close after delay
                setTimeout(function() {
                    google.script.host.close();
                }, 3000);
            } else {
                showError(result.message || 'Failed to create enhanced maternity case');
            }
        }
        
        function handleEnhancedError(error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            showError('Enhanced processing error: ' + error.message);
        }
        
        function showError(message) {
            document.getElementById('error-message').innerHTML = message;
            document.getElementById('error-message').style.display = 'block';
        }
        
        function showWarning(message) {
            document.getElementById('warning-message').innerHTML = message;
            document.getElementById('warning-message').style.display = 'block';
        }
        
        function showSuccess(message) {
            document.getElementById('success-message').innerHTML = message;
            document.getElementById('success-message').style.display = 'block';
        }
        
        function hideAllMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('warning-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
    </script>
</body>
</html>
