/**
 * Creates the main menu when the spreadsheet opens.
 */

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  const userEmail = Session.getEffectiveUser().getEmail();
  const isAdmin = CONFIG.ADMIN_EMAILS.includes(userEmail);

  // === Standard HR & Payroll menu (all users) ===
  const mainMenu = ui.createMenu('üè¢ HR & Payroll');
  mainMenu.addItem('üë• Show Employee Stats', 'showEmployeeStats');
  mainMenu.addSeparator();
  mainMenu.addItem('üí∞ NMW Advanced Checker', 'showEnhancedNMWComplianceSidebar');
  mainMenu.addItem('üìç NMW Location Checker', 'showNMWLocationSidebar');
  mainMenu.addSeparator();
  mainMenu.addItem('ü§± Maternity Dashboard', 'showMaternityDashboard'); 
  mainMenu.addSeparator();
  mainMenu.addItem('‚ûï Submit Feature Request', 'showFeatureRequestSubmissionForm');
  mainMenu.addToUi();

  // === Admin-only tools in separate menu ===
  if (isAdmin) {
    const adminMenu = ui.createMenu('üîê Admin Tools');
    adminMenu.addItem('üîÑ File Comparison Tool', 'showFileComparisonTool');
    adminMenu.addItem('üîç Pre-Payroll Validation', 'showPrePayrollValidationDashboard');
    adminMenu.addSeparator();
    adminMenu.addItem('Take Data Snapshot', 'saveWeeklyEmployeeSnapshot');
    adminMenu.addItem('üìÖ Show Pay Periods', 'showPayPeriods');
    adminMenu.addItem('‚è∞ Show Upcoming Deadlines', 'showUpcomingDeadlines');
    adminMenu.addSeparator();
    adminMenu.addItem('üí° Feature Request Dashboard', 'showFeatureRequestDashboard');
    adminMenu.addSeparator();
    adminMenu.addItem('‚ûï New Maternity Leave', 'showNewMaternityCaseForm'); 
    adminMenu.addItem('üß™ Test Maternity (Console)', 'testMaternityModuleConsole'); // Debug tool
    adminMenu.addItem('üóìÔ∏è Team Absence Planner', 'showTeamAbsencePlanner');
    adminMenu.addItem('üöó EV Scheme Management', 'showEVSchemeDashboard');
    adminMenu.addSeparator();
    adminMenu.addItem('üìö Journal Export Dashboard', 'showJournalExportSidebar');
    adminMenu.addToUi();
  }

  // === Reporting Menu (Currently Admin-only. Future Access TBC)
  if (isAdmin) {
    const reportingMenu = ui.createMenu ('üìä Reporting');
    reportingMenu.addItem('Reports Dashboard', 'showReportsDashboard')
    reportingMenu.addItem('üìä Generate Monthly ONS Report', 'showMonthlyONSEmployeeCount');
    reportingMenu.addToUi();
  }
}

// === JOURNAL FUNCTIONS ===

/**
 * Shows the journal export sidebar for multi-journal processing
 */
function showJournalExportSidebar() {
  const html = HtmlService.createHtmlOutputFromFile('12_journalSidebar')
    .setTitle("Export Payroll Journals")
    .setWidth(350);
  SpreadsheetApp.getUi().showSidebar(html);
}

// === Employee Functions (using existing functions) ===

/**
 * Shows basic employee statistics.
 */
function showEmployeeStats() {
  try {
    const allEmployees = getAllEmployees();
    const activePayroll = getActivePayrollEmployees();
    const locations = listUniqueLocations();
    const divisions = listUniqueDivisions();
    const payTypes = listUniquePayTypes();
    
    const stats = `üìä EMPLOYEE STATISTICS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üë• Total Employees: ${allEmployees.length}
üíº Active Payroll: ${activePayroll.length}
üìç Locations: ${locations.length}
üè¢ Divisions: ${divisions.length}
üí∞ Pay Types: ${payTypes.join(', ')}

Top 3 Locations:
${locations.slice(0, 3).map(loc => `‚Ä¢ ${loc}`).join('\n')}`;
    
    SpreadsheetApp.getUi().alert('Employee Statistics', stats, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error', `Failed to load employee data: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// === Payroll Functions (using existing functions) ===

/**
 * Shows current pay periods.
 */
function showPayPeriods() {
  try {
    const hourlyPeriod = getCurrentPayPeriod('Hourly');
    const salariedPeriod = getCurrentPayPeriod('Salaried');
    
    let info = 'üìÖ CURRENT PAY PERIODS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    if (hourlyPeriod) {
      info += `‚è∞ Hourly Staff:\n`;
      info += `   Period: ${hourlyPeriod.periodStart.toLocaleDateString()} - ${hourlyPeriod.periodEnd.toLocaleDateString()}\n`;
      info += `   Pay Date: ${hourlyPeriod.payDate.toLocaleDateString()}\n\n`;
    }
    
    if (salariedPeriod) {
      info += `üíº Salaried Staff:\n`;
      info += `   Period: ${salariedPeriod.periodStart.toLocaleDateString()} - ${salariedPeriod.periodEnd.toLocaleDateString()}\n`;
      info += `   Pay Date: ${salariedPeriod.payDate.toLocaleDateString()}\n`;
    }
    
    SpreadsheetApp.getUi().alert('Current Pay Periods', info, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error', `Failed to load pay periods: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Shows upcoming payroll deadlines.
 */
function showUpcomingDeadlines() {
  try {
    const deadlines = getUpcomingPayrollDeadlines(30);
    
    let info = '‚è∞ UPCOMING DEADLINES (30 Days)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    if (deadlines.length === 0) {
      info += 'No upcoming deadlines in the next 30 days.';
    } else {
      deadlines.forEach(deadline => {
        const icon = deadline.type === 'cutoff' ? '‚úÇÔ∏è' : 'üí∞';
        info += `${icon} ${deadline.date.toLocaleDateString()} - ${deadline.type}\n`;
        info += `   ${deadline.period.staffType} (${deadline.daysUntil} days)\n\n`;
      });
    }
    
    SpreadsheetApp.getUi().alert('Upcoming Deadlines', info, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error', `Failed to load deadlines: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Simple payroll calendar test.
 */
function testPayrollCalendar() {
  try {
    const calendar = getPayrollCalendar();
    const validation = validateEmployeePayTypeConsistency();
    
    let result = 'üß™ PAYROLL CALENDAR TEST\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    result += `‚úÖ Calendar loaded: ${calendar.length} periods\n`;
    result += `${validation.isValid ? '‚úÖ' : '‚ùå'} Employee consistency: ${validation.summary}\n`;
    
    SpreadsheetApp.getUi().alert('Payroll Test Results', result, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Test Failed', error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// === NMW Functions (using existing functions) ===

/**
 * Shows NMW system health.
 */
function showNMWSystemHealth() {
  try {
    const health = getNMWSystemHealth();
    
    let status = `üè• NMW SYSTEM HEALTH\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nOverall: ${health.overall.toUpperCase()}\n\n`;
    
    Object.entries(health.components).forEach(([component, info]) => {
      const icon = info.status === 'healthy' ? '‚úÖ' : info.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
      status += `${icon} ${component}: ${info.message}\n`;
    });
    
    SpreadsheetApp.getUi().alert('NMW System Health', status, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Health Check Failed', error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// === Feature Request Functions (Module 05) ===

/**
 * Shows feature request analytics in a popup.
 */
function showFeatureRequestAnalytics() {
  try {
    const analytics = getFeatureRequestAnalytics();
    
    let report = `üìä FEATURE REQUEST ANALYTICS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    
    // Overview
    report += `üìà OVERVIEW:\n`;
    report += `‚Ä¢ Total Requests: ${analytics.overview.total}\n`;
    report += `‚Ä¢ Active: ${analytics.overview.active}\n`;
    report += `‚Ä¢ Completed: ${analytics.overview.completed}\n`;
    report += `‚Ä¢ Needing Attention: ${analytics.overview.needingAttention}\n\n`;
    
    // By Status
    report += `üìã BY STATUS:\n`;
    Object.entries(analytics.byStatus).forEach(([status, count]) => {
      if (count > 0) report += `‚Ä¢ ${status}: ${count}\n`;
    });
    
    report += `\nüéØ BY PRIORITY:\n`;
    Object.entries(analytics.byPriority).forEach(([priority, count]) => {
      if (count > 0) report += `‚Ä¢ ${priority}: ${count}\n`;
    });
    
    report += `\nüìÇ BY CATEGORY:\n`;
    Object.entries(analytics.byCategory).forEach(([category, count]) => {
      if (count > 0) report += `‚Ä¢ ${category}: ${count}\n`;
    });
    
    SpreadsheetApp.getUi().alert('Feature Request Analytics', report, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Analytics Error', `Failed to generate analytics: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Shows feature request system health.
 */
function showFeatureRequestSystemHealth() {
  try {
    const health = getFeatureRequestSystemHealth();
    
    let status = `üè• FEATURE REQUEST SYSTEM HEALTH\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nOverall: ${health.overall.toUpperCase()}\n\n`;
    
    Object.entries(health.components).forEach(([component, info]) => {
      const icon = info.status === 'healthy' ? '‚úÖ' : info.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
      status += `${icon} ${component}: ${info.message}\n`;
    });
    
    status += `\nLast Checked: ${health.lastChecked.toLocaleString()}`;
    
    SpreadsheetApp.getUi().alert('Feature Request System Health', status, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('Health Check Failed', error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// === Helper Functions ===

/**
 * Shows simple help information.
 */
function showQuickHelp() {
  const help = `üÜò QUICK HELP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üè¢ AVAILABLE FUNCTIONS:

üë• EMPLOYEES:
‚Ä¢ Show Employee Stats - Basic statistics
‚Ä¢ Test Employee Directory - Run diagnostics

üìÖ PAYROLL:
‚Ä¢ Show Pay Periods - Current periods
‚Ä¢ Show Upcoming Deadlines - Next 30 days
‚Ä¢ Test Payroll Calendar - System check

üìö JOURNALS:
‚Ä¢ Journal Export Dashboard - Multi-journal interface
  - Investment Journal - Process investment payroll
  - Hourly Journal - Process hourly staff + tips
  - Salaried Journal - Process salaried staff + tips
  - Hourly Accrual - Copy accrual files
  - Cross Charge Journal - Inter-hotel transfers

üí∞ NMW COMPLIANCE:
‚Ä¢ NMW Advanced Checker - Full filtering UI
‚Ä¢ NMW Location Checker - Simple location check
‚Ä¢ Test NMW System - Run diagnostics
‚Ä¢ NMW System Health - Component status

ü§± MATERNITY MANAGEMENT:
‚Ä¢ Maternity Dashboard - View all active cases
‚Ä¢ New Maternity Leave - Create new case (Admin)
‚Ä¢ Test Maternity Module - Run diagnostics (Admin)

üí° FEATURE REQUESTS:
‚Ä¢ Feature Request Dashboard - Manage all requests
‚Ä¢ Submit Feature Request - Create new request
‚Ä¢ Feature Request Analytics - View statistics
‚Ä¢ Test Feature Requests - Run diagnostics
‚Ä¢ Feature Request Health - System status

üîß TROUBLESHOOTING:
‚Ä¢ Run the test functions if something breaks
‚Ä¢ Check system health for component status
‚Ä¢ Reset employee cache if data seems stale`;
  
  SpreadsheetApp.getUi().alert('Quick Help', help, SpreadsheetApp.getUi().ButtonSet.OK);
}
